<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>بازی املا: مرتب‌سازی حروف و جملات (مخصوص دانش‌آموزان ابتدایی)</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --bg: #fffdf8;
      --card: #fff;
      --accent: #ff6f61;
      --ok: #2ecc71;
      --bad: #e74c3c;
      --highlight: #ffd700;
      --text: #2c3e50;
      --sidebar-bg: rgba(255, 255, 255, 0.98);
      --slot-bg: linear-gradient(180deg, #fff, #f7fbff);
      --slot-filled-bg: linear-gradient(180deg, #f6fff5, #e6fff0);
      --msg-bg: #fff9eb;
      --msg-border: #ffe6a8;
      --table-header: #4CAF50;
      --table-row-odd: #e6fff0;
      --table-row-even: #f0f8ff;
    }
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --card: #2c2c2c;
      --accent: #ff8781;
      --ok: #27ae60;
      --bad: #c0392b;
      --highlight: #ffca28;
      --text: #ecf0f1;
      --sidebar-bg: rgba(44, 44, 44, 0.98);
      --slot-bg: linear-gradient(180deg, #2c2c2c, #333);
      --slot-filled-bg: linear-gradient(180deg, #2ecc71, #27ae60);
      --msg-bg: #3c2f2f;
      --msg-border: #e67e22;
      --table-header: #388E3C;
      --table-row-odd: #2f4b3f;
      --table-row-even: #3b4a5c;
    }
    html, body {
      margin: 0;
      font-family: Tahoma, 'Vazir', Arial, sans-serif;
      background: linear-gradient(45deg, #ffecd2, #fce6e6, #e6fffd);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
      overscroll-behavior: none;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 111, 97, 0.4); }
      50% { transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 111, 97, 0.6); }
      100% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 111, 97, 0.4); }
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text);
    }
    .wrap {
      width: 100%;
      max-width: 980px;
      padding: 12px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 100vh;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
    }
    h1 {
      margin: 0;
      font-size: clamp(16px, 5vw, 18px);
    }
    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: 0;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: clamp(12px, 4vw, 14px);
      touch-action: manipulation;
      transition: transform 0.2s, background 0.2s;
    }
    button:hover {
      transform: scale(1.05);
      background: #e65b50;
    }
    button.secondary {
      background: #7a8aa6;
    }
    button.secondary:hover {
      background: #5f6f8a;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 12px;
      flex-grow: 1;
    }
    .stage {
      background: var(--slot-bg);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(12, 40, 80, 0.06);
      min-height: 300px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .prompt {
      font-weight: 800;
      font-size: clamp(16px, 5vw, 18px);
      text-align: center;
    }
    .progress-bar-container {
      width: 100%;
      height: 10px;
      background: #e6e6e6;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: var(--ok);
      width: 0%;
      transition: width 0.3s ease;
    }
    .timer-circle {
      width: 50px;
      height: 50px;
      margin: 0 auto;
      position: relative;
    }
    .timer-circle svg {
      transform: rotate(-90deg);
    }
    .timer-circle .circle-bg {
      fill: none;
      stroke: #e6e6e6;
      stroke-width: 4;
    }
    .timer-circle .circle-progress {
      fill: none;
      stroke: var(--accent);
      stroke-width: 4;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }
    .timer-circle .timer-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(12px, 4vw, 14px);
      font-weight: 700;
    }
    .scrambled {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      padding: 8px;
    }
    .tile {
      width: clamp(60px, 18vw, 80px);
      height: clamp(60px, 18vw, 80px);
      border-radius: 10px;
      background: var(--card);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(20px, 6vw, 24px);
      font-weight: 900;
      box-shadow: 0 8px 12px rgba(20, 40, 80, 0.06);
      cursor: move;
      user-select: none;
      touch-action: none;
      position: relative;
      z-index: 10;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
    }
    .tile:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 20px rgba(20, 40, 80, 0.1), 0 0 10px rgba(255, 111, 97, 0.3);
    }
    .tile.dragging {
      opacity: 0.85;
      transform: scale(1.06);
      z-index: 1000;
    }
    .tile.correct {
      background: var(--ok);
      transition: background 0.2s;
    }
    .tile.incorrect {
      background: var(--bad);
      transition: background 0.2s;
    }
    .slot-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      padding: 8px;
    }
    .slot {
      width: clamp(60px, 18vw, 80px);
      height: clamp(60px, 18vw, 80px);
      border-radius: 10px;
      border: 2px dashed #e6eefc;
      background: var(--slot-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(18px, 5vw, 20px);
      font-weight: 800;
      cursor: pointer;
      position: relative;
      z-index: 5;
      transition: border 0.2s, background 0.2s, outline 0.2s;
    }
    .slot.filled {
      border-style: solid;
      border-color: var(--ok);
      background: var(--slot-filled-bg);
    }
    .slot.incorrect {
      animation: shake 0.3s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }
    aside {
      background: var(--sidebar-bg);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(12, 40, 80, 0.05);
      height: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    label {
      font-weight: 700;
      font-size: clamp(12px, 4vw, 13px);
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      max-width: 200px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #dde;
      font-size: clamp(12px, 4vw, 14px);
      background: var(--card);
      color: var(--text);
    }
    textarea {
      width: 100%;
      height: 120px;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #dde;
      resize: vertical;
      font-size: clamp(12px, 4vw, 14px);
      background: var(--card);
      color: var(--text);
    }
    .score, .stats, .moves, .mistakes {
      font-size: clamp(14px, 4.5vw, 16px);
      font-weight: 800;
    }
    .progress {
      font-size: clamp(12px, 4vw, 14px);
      font-weight: 700;
    }
    .level {
      font-size: clamp(12px, 4vw, 14px);
      font-weight: 700;
      color: #8e44ad;
    }
    .streak {
      font-size: clamp(12px, 4vw, 14px);
      font-weight: 700;
      color: #e67e22;
    }
    .msg {
      padding: 8px;
      border-radius: 8px;
      background: var(--msg-bg);
      border: 1px dashed var(--msg-border);
      font-size: clamp(12px, 4vw, 14px);
    }
    footer.small {
      font-size: clamp(11px, 3.5vw, 12px);
      color: var(--text);
      margin-top: auto;
    }
    #printFrame {
      display: none;
    }
    .report-card-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-family: 'Vazir', sans-serif;
      direction: rtl;
      text-align: right;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(12, 40, 80, 0.1);
    }
    .report-card-table th, .report-card-table td {
      border: 1px solid #ddd;
      padding: 12px;
      font-size: 14px;
    }
    .report-card-table th {
      background-color: var(--table-header);
      color: white;
      font-weight: bold;
    }
    .report-card-table tr:nth-child(odd) {
      background-color: var(--table-row-odd);
    }
    .report-card-table tr:nth-child(even) {
      background-color: var(--table-row-even);
    }
    @media (max-width: 880px) {
      main {
        grid-template-columns: 1fr;
      }
      .wrap {
        padding: 8px;
      }
      .stage {
        min-height: 250px;
      }
      .tile, .slot {
        width: clamp(50px, 20vw, 70px);
        height: clamp(50px, 20vw, 70px);
      }
      .tile {
        font-size: clamp(18px, 5.5vw, 22px);
      }
      .slot {
        font-size: clamp(16px, 5vw, 18px);
      }
    }
    @media (max-width: 480px) {
      h1 {
        font-size: clamp(14px, 4.5vw, 16px);
      }
      button {
        padding: 5px 8px;
        font-size: clamp(11px, 3.5vw, 12px);
      }
      .prompt {
        font-size: clamp(14px, 4.5vw, 16px);
      }
      textarea {
        height: 100px;
      }
      input[type="number"], input[type="text"] {
        max-width: 100%;
      }
      .timer-circle {
        width: 40px;
        height: 40px;
      }
      .report-card-table th, .report-card-table td {
        font-size: 12px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <audio id="bgMusic" autoplay loop>
    <source src="background_music.mp3" type="audio/mpeg">
    مرورگر شما از پخش صدا پشتیبانی نمی‌کند.
  </audio>
  <div class="wrap">
    <header>
      <h1>🎓 بازی املا: مرتب‌سازی حروف و جملات (مخصوص دانش‌آموزان ابتدایی)</h1>
      <div class="top-controls">
        <button id="newBtn">🔁 جدید</button>
        <button id="checkBtn">✔ بررسی</button>
        <button id="retryBtn" class="secondary">🔄 دوباره</button>
        <button id="themeBtn" class="secondary">🌙 تم</button>
        <button id="resetBtn" class="secondary">🗑 بازنشانی</button>
        <button id="printBtn" class="secondary">🖨 چاپ کارنامه</button>
      </div>
    </header>
    <main>
      <section class="stage" id="stage">
        <div class="prompt" id="prompt">برای شروع «جدید» را بزن</div>
        <div class="timer-circle" id="timerCircle" style="display: none;">
          <svg width="50" height="50">
            <circle class="circle-bg" cx="25" cy="25" r="22" />
            <circle class="circle-progress" cx="25" cy="25" r="22" stroke-dasharray="138" stroke-dashoffset="0" />
          </svg>
          <div class="timer-text" id="timerText">0</div>
        </div>
        <div class="progress" id="progress">پیشرفت: 0/0</div>
        <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="level" id="level">سطح: 1</div>
        <div class="streak" id="streak">رگه: 0</div>
        <div class="moves" id="moves">حرکات باقی‌مانده: 10</div>
        <div class="mistakes" id="mistakes">اشتباهات باقی‌مانده: 3</div>
        <div style="font-weight: 700; text-align: center; font-size: clamp(12px, 4vw, 14px)">جای درست را بساز</div>
        <div class="slot-row" id="slots"></div>
        <div style="display: flex; gap: 8px; justify-content: center; margin-top: 6px">
          <button id="shuffleTiles" class="secondary">🔀 مخلوط کن</button>
        </div>
      </section>
      <aside>
        <div class="score">امتیاز: <span id="score">0</span></div>
        <div class="stats">دقت: <span id="accuracy">0%</span> | میانگین زمان: <span id="avgTime">0 ثانیه</span></div>
        <div class="msg" id="msg">هر بار که کلمه یا جمله را درست بسازی امتیاز می‌گیری. فقط جملات وارد کن!</div>
        <div style="font-weight: 700; font-size: clamp(12px, 4vw, 14px)">قطعات (لمس/کلیک و بکش)</div>
        <div class="scrambled" id="scrambled"></div>
        <label for="wordList">فهرست جملات (یک جمله در هر خط)</label>
        <textarea id="wordList">من به مدرسه می‌روم
این یک کتاب است
ما بازی می‌کنیم
خورشید در آسمان است
گربه روی دیوار است
من سیب می‌خورم
کتاب روی میز است
ما به پارک می‌رویم
پرنده در آسمان پرواز می‌کند
امروز روز خوبی است</textarea>
        <label for="timerDuration">مدت زمان (ثانیه، 10-60):</label>
        <input type="number" id="timerDuration" min="10" max="60" value="30">
        <div style="display: flex; gap: 8px; flex-wrap: wrap">
          <button id="applyBtn">اعمال فهرست</button>
          <button id="suggestBtn" class="secondary">پیشنهاد جملات</button>
          <button id="modeBtn" class="secondary">حالت: سیلاب</button>
          <button id="gameModeBtn" class="secondary">حالت بازی: عادی</button>
        </div>
        <div style="margin-top: 6px; font-size: clamp(11px, 3.5vw, 12px)">تنظیمات: <br> حالت «سیلاب» — کلمات به دو حرف. <br> حالت «حرف» — کلمات به حرف. <br> حالت «جمله» — کلمات یک جمله. <br> حالت‌های بازی: عادی، زمان‌دار، چالش</div>
        <footer class="small">می‌خواهی من فهرست جملات مناسب برای گروه سنی درست کنم؟ از دکمه «پیشنهاد جملات» استفاده کن.</footer>
      </aside>
    </main>
    <iframe id="printFrame" style="display: none;"></iframe>
  </div>
  <script>
    let WORDS = [
      'من به مدرسه می‌روم',
      'این یک کتاب است',
      'ما بازی می‌کنیم',
      'خورشید در آسمان است',
      'گربه روی دیوار است',
      'من سیب می‌خورم',
      'کتاب روی میز است',
      'ما به پارک می‌رویم',
      'پرنده در آسمان پرواز می‌کند',
      'امروز روز خوبی است'
    ];
    let current = null;
    let currentSentence = null;
    let tiles = [];
    let mode = 'syllable';
    let gameMode = 'normal';
    let score = 0;
    let completedWords = 0;
    let totalWords = 0;
    let streak = 0;
    let level = 1;
    let draggingEl = null;
    let timerInterval = null;
    let timeLeft = 30;
    let totalAttempts = 0;
    let correctAttempts = 0;
    let roundStartTime = 0;
    let totalRoundTime = 0;
    let moveCount = 10; // محدودیت تعداد حرکت
    let maxMoves = 10; // حداکثر حرکات در هر دور
    let mistakeCount = 3; // محدودیت تعداد اشتباه
    let maxMistakes = 3; // حداکثر اشتباهات در هر دور
    let consecutiveMistakes = 0; // برای دشواری پویا
    let usedSentences = JSON.parse(localStorage.getItem('usedSentences')) || [];
    let achievements = JSON.parse(localStorage.getItem('achievements')) || {
      fiveInRow: false,
      tenPoints: false
    };
    let userInfo = JSON.parse(localStorage.getItem('userInfo')) || {
      firstName: '',
      lastName: '',
      nationalId: '',
      schoolName: '',
      grade: ''
    };
    let settings = JSON.parse(localStorage.getItem('settings')) || {
      mode: 'syllable',
      gameMode: 'normal',
      timerDuration: 30,
      theme: 'light'
    };
    const encouragementMessages = [
      'عالی بود، تو یه ستاره درخشان املایی! 🌟',
      'آفرین، انگار با جادوی املا همه رو غافلگیر کردی! 🧙‍♂️',
      'وای، چه سرعت و دقتی! تو یه موشک املایی! 🚀',
      'خوب بود، حالا یکی دیگه، پادشاه املا! 👑',
      'فوق‌العاده! انگار املا رو با چشمای بسته حل کردی! 😎',
      'هورا! این یکی رو مثل یه حرفه‌ای ترکوندی! 💥',
      'تو بهترینی! آماده‌ای یه املای دیگه رو فتح کنی؟ ⚔️',
      'آخ جون! انگار داری با املا نقاشی‌های رنگارنگ می‌کشی! 🎨',
      'وای، تو یه غول املایی هستی که همه رو شگفت‌زده کرد! 😍'
    ];

    const scrambledEl = document.getElementById('scrambled');
    const slotsEl = document.getElementById('slots');
    const promptEl = document.getElementById('prompt');
    const scoreEl = document.getElementById('score');
    const progressEl = document.getElementById('progress');
    const progressBarEl = document.getElementById('progressBar');
    const levelEl = document.getElementById('level');
    const streakEl = document.getElementById('streak');
    const movesEl = document.getElementById('moves');
    const mistakesEl = document.getElementById('mistakes');
    const msgEl = document.getElementById('msg');
    const wordListEl = document.getElementById('wordList');
    const timerDurationEl = document.getElementById('timerDuration');
    const timerCircleEl = document.getElementById('timerCircle');
    const timerTextEl = document.getElementById('timerText');
    const accuracyEl = document.getElementById('accuracy');
    const avgTimeEl = document.getElementById('avgTime');

    function loadWordList() {
      const savedWords = localStorage.getItem('wordList');
      if (savedWords) {
        WORDS = JSON.parse(savedWords).map(s => normalizePersian(s)).filter(Boolean);
      }
      wordListEl.value = WORDS.join('\n');
    }

    function saveWordList() {
      const newWords = wordListEl.value.split('\n').map(s => normalizePersian(s)).filter(Boolean);
      if (newWords.length === 0) {
        Swal.fire({
          icon: 'error',
          title: 'خطا',
          text: 'لطفاً دست‌کم یک جمله وارد کنید',
          confirmButtonText: 'باشه'
        });
        return;
      }
      WORDS = newWords;
      localStorage.setItem('wordList', JSON.stringify(WORDS));
      usedSentences = [];
      localStorage.setItem('usedSentences', JSON.stringify(usedSentences));
      Swal.fire({
        icon: 'success',
        title: 'اعمال شد',
        text: 'فهرست جملات به‌روزرسانی شد. حالا «جدید» را بزن.',
        timer: 1500,
        showConfirmButton: false
      });
    }

    function saveSettings() {
      settings = {
        mode,
        gameMode,
        timerDuration: parseInt(timerDurationEl.value) || 30,
        theme: document.documentElement.getAttribute('data-theme') || 'light'
      };
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    function loadSettings() {
      mode = settings.mode || 'syllable';
      gameMode = settings.gameMode || 'normal';
      timerDurationEl.value = settings.timerDuration || 30;
      if (settings.theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').textContent = '☀️ تم';
      }
      document.getElementById('modeBtn').textContent = `حالت: ${mode === 'syllable' ? 'سیلاب' : mode === 'letter' ? 'حرف' : 'جمله'}`;
      document.getElementById('gameModeBtn').textContent = `حالت بازی: ${gameMode === 'normal' ? 'عادی' : gameMode === 'timed' ? 'زمان‌دار' : 'چالش'}`;
    }

    function normalizePersian(s) {
      return (s || '').replace(/\u200c/g, '').replace(/[\s]+/g, ' ').replace(/[آأإ]/g, 'ا').replace(/ي/g, 'ی').replace(/ك/g, 'ک').trim();
    }

    function splitSyllables(word) {
      const chars = Array.from(word.replace(/\s/g, ''));
      const parts = [];
      for (let i = 0; i < chars.length; i += 2) {
        parts.push(chars.slice(i, i + 2).join(''));
      }
      return parts.length > 0 ? parts : splitLetters(word);
    }

    function splitLetters(word) {
      return Array.from(word.replace(/\s/g, ''));
    }

    function splitSentence(sentence) {
      return sentence.split(/\s+/).filter(Boolean);
    }

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function updateLevel() {
      const newLevel = Math.floor(completedWords / 5) + 1;
      if (newLevel !== level) {
        level = newLevel;
        levelEl.textContent = `سطح: ${level}`;
        levelEl.style.animation = 'pulse 1s';
        setTimeout(() => levelEl.style.animation = '', 1000);
        Swal.fire({
          icon: 'success',
          title: 'سطح جدید!',
          text: `تبریک! به سطح ${level} رسیدی!`,
          timer: 1500,
          showConfirmButton: false
        });
      }
    }

    function updateStats() {
      const accuracy = totalAttempts > 0 ? Math.round((correctAttempts / totalAttempts) * 100) : 0;
      const avgTime = completedWords > 0 ? Math.round(totalRoundTime / completedWords) : 0;
      accuracyEl.textContent = `${accuracy}%`;
      avgTimeEl.textContent = `${avgTime} ثانیه`;
    }

    function selectSentenceByDifficulty() {
      let availableSentences = WORDS.filter(s => !usedSentences.includes(s));
      if (availableSentences.length === 0) {
        usedSentences = [];
        availableSentences = WORDS;
      }
      if (gameMode === 'challenge') {
        // در حالت چالش، جملات بر اساس طول مرتب می‌شوند
        return availableSentences.sort((a, b) => a.length - b.length)[Math.min(completedWords, availableSentences.length - 1)];
      }
      // دشواری پویا: بر اساس streak و consecutiveMistakes
      if (streak >= 5) {
        // انتخاب جملات طولانی‌تر (بیش از 15 کاراکتر)
        const longSentences = availableSentences.filter(s => s.length > 15);
        return longSentences.length > 0 ? longSentences[Math.floor(Math.random() * longSentences.length)] : availableSentences[Math.floor(Math.random() * availableSentences.length)];
      } else if (consecutiveMistakes >= 3) {
        // انتخاب جملات کوتاه‌تر (کمتر از 10 کاراکتر)
        const shortSentences = availableSentences.filter(s => s.length <= 10);
        return shortSentences.length > 0 ? shortSentences[Math.floor(Math.random() * shortSentences.length)] : availableSentences[Math.floor(Math.random() * availableSentences.length)];
      }
      // انتخاب تصادفی در حالت عادی
      return availableSentences[Math.floor(Math.random() * availableSentences.length)];
    }

    function newRound() {
      if (WORDS.length === 0) {
        Swal.fire({
          icon: 'error',
          title: 'خطا',
          text: 'لطفاً دست‌کم یک جمله وارد کنید',
        });
        return;
      }
      currentSentence = selectSentenceByDifficulty();
      usedSentences.push(currentSentence);
      localStorage.setItem('usedSentences', JSON.stringify(usedSentences));
      const sentenceWords = splitSentence(currentSentence);
      current = mode === 'sentence' ? currentSentence : sentenceWords[Math.floor(Math.random() * sentenceWords.length)];
      promptEl.textContent = gameMode === 'timed' ? `زمان: ${timeLeft} ثانیه` : mode === 'sentence' ? 'جمله جدید — ترتیب را درست کن' : `کلمه جدید — ترتیب را درست کن: ${current}`;
      tiles = mode === 'sentence' ? splitSentence(current) : mode === 'syllable' ? splitSyllables(current) : splitLetters(current);
      if (tiles.length === 0) tiles = splitLetters(current);
      totalWords++;
      moveCount = maxMoves; // بازنشانی تعداد حرکات
      mistakeCount = maxMistakes; // بازنشانی تعداد اشتباهات
      movesEl.textContent = `حرکات باقی‌مانده: ${moveCount}`;
      mistakesEl.textContent = `اشتباهات باقی‌مانده: ${mistakeCount}`;
      updateProgress();
      renderTiles();
      renderSlots();
      if (gameMode === 'timed') {
        timeLeft = parseInt(timerDurationEl.value) || 30;
        timeLeft = Math.max(10, Math.min(60, timeLeft));
        timerCircleEl.style.display = 'block';
        promptEl.textContent = `زمان: ${timeLeft} ثانیه`;
        updateTimerCircle();
        clearInterval(timerInterval);
        roundStartTime = Date.now();
        timerInterval = setInterval(() => {
          timeLeft--;
          promptEl.textContent = `زمان: ${timeLeft} ثانیه`;
          timerTextEl.textContent = timeLeft;
          updateTimerCircle();
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerCircleEl.style.display = 'none';
            Swal.fire({
              icon: 'error',
              title: 'زمان تمام شد!',
              text: 'دوباره تلاش کن یا از «جدید» استفاده کن.',
              confirmButtonText: 'باشه'
            });
            streak = 0;
            consecutiveMistakes++;
            updateStreak();
            retryRound();
          }
        }, 1000);
      } else {
        timerCircleEl.style.display = 'none';
        roundStartTime = Date.now();
      }
      saveSettings();
    }

    function updateProgress() {
      progressEl.textContent = `پیشرفت: ${completedWords}/${totalWords}`;
      const progressPercent = totalWords > 0 ? (completedWords / totalWords) * 100 : 0;
      progressBarEl.style.width = `${progressPercent}%`;
      updateLevel();
      updateStats();
    }

    function updateStreak() {
      streakEl.textContent = `رگه: ${streak}`;
    }

    function updateTimerCircle() {
      const totalTime = parseInt(timerDurationEl.value) || 30;
      const progress = timeLeft / totalTime;
      const dashOffset = 138 * (1 - progress);
      document.querySelector('.circle-progress').style.strokeDashoffset = dashOffset;
    }

    function renderTiles() {
      scrambledEl.innerHTML = '';
      const shuffledTiles = shuffle(tiles.map((x, i) => ({ id: i, text: x })));
      shuffledTiles.forEach(obj => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.textContent = obj.text;
        tile.dataset.text = obj.text;
        tile.dataset.id = obj.id;
        scrambledEl.appendChild(tile);
        enableDrag(tile);
      });
    }

    function renderSlots() {
      slotsEl.innerHTML = '';
      tiles.forEach((_, i) => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.dataset.index = i;
        slot.dataset.occupied = 'false';
        slot.addEventListener('click', () => handleSlotClick(slot));
        slotsEl.appendChild(slot);
      });
    }

    function enableDrag(el) {
      el.addEventListener('pointerdown', e => {
        e.preventDefault();
        if (draggingEl) return;
        draggingEl = el;
        el.setPointerCapture(e.pointerId);
        el.classList.add('dragging');
        const rect = el.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const offsetY = e.clientY - rect.top;
        el.style.position = 'fixed';
        el.style.left = rect.left + 'px';
        el.style.top = rect.top + 'px';
        el.style.zIndex = '1000';

        function onMove(ev) {
          ev.preventDefault();
          el.style.left = (ev.clientX - offsetX) + 'px';
          el.style.top = (ev.clientY - offsetY) + 'px';
        }

        function onUp(ev) {
          ev.preventDefault();
          el.releasePointerCapture(e.pointerId);
          document.removeEventListener('pointermove', onMove);
          document.removeEventListener('pointerup', onUp);
          el.classList.remove('dragging');

          el.style.visibility = 'hidden';
          const dropped = document.elementFromPoint(ev.clientX, ev.clientY);
          el.style.visibility = '';
          
          const slot = dropped?.closest('.slot');
          if (slot && slot.dataset.occupied === 'false' && validateDrop(slot, el)) {
            slot.textContent = el.dataset.text;
            slot.dataset.occupied = 'true';
            slot.style.transition = 'all 0.2s ease';
            slot.style.transform = 'scale(1.1)';
            setTimeout(() => slot.style.transform = 'scale(1)', 200);
            el.classList.add('correct');
            setTimeout(() => el.classList.remove('correct'), 300);
            el.remove();
            moveCount--;
            movesEl.textContent = `حرکات باقی‌مانده: ${moveCount}`;
            if (moveCount <= 0) {
              Swal.fire({
                icon: 'error',
                title: 'حرکات تمام شد!',
                text: 'تعداد حرکاتت تموم شد. دوباره تلاش کن یا از «جدید» استفاده کن.',
                confirmButtonText: 'باشه'
              });
              streak = 0;
              consecutiveMistakes++;
              updateStreak();
              retryRound();
              return;
            }
            checkIfComplete();
          } else {
            el.classList.add('incorrect');
            setTimeout(() => el.classList.remove('incorrect'), 300);
            el.style.transition = 'all 0.3s ease';
            const scrambledRect = scrambledEl.getBoundingClientRect();
            el.style.left = scrambledRect.left + 'px';
            el.style.top = scrambledRect.top + 'px';
            setTimeout(() => {
              el.style.position = '';
              el.style.left = '';
              el.style.top = '';
              el.style.zIndex = '';
              el.style.transition = '';
              scrambledEl.appendChild(el);
            }, 300);
          }
          draggingEl = null;
        }

        document.addEventListener('pointermove', onMove);
        document.addEventListener('pointerup', onUp);
      });
    }

    function validateDrop(slot, tile) {
      if (!slot || slot.dataset.occupied === 'true') return false;
      if (!tile.dataset.text) return false;
      return true;
    }

    function handleSlotClick(slot) {
      if (slot.dataset.occupied === 'true') {
        const text = slot.textContent;
        slot.textContent = '';
        slot.dataset.occupied = 'false';
        slot.classList.remove('filled', 'incorrect');
        slot.style.transform = 'scale(0.9)';
        setTimeout(() => slot.style.transform = 'scale(1)', 200);
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.textContent = text;
        tile.dataset.text = text;
        scrambledEl.appendChild(tile);
        enableDrag(tile);
        moveCount--;
        movesEl.textContent = `حرکات باقی‌مانده: ${moveCount}`;
        if (moveCount <= 0) {
          Swal.fire({
            icon: 'error',
            title: 'حرکات تمام شد!',
            text: 'تعداد حرکاتت تموم شد. دوباره تلاش کن یا از «جدید» استفاده کن.',
            confirmButtonText: 'باشه'
          });
          streak = 0;
          consecutiveMistakes++;
          updateStreak();
          retryRound();
          return;
        }
      }
    }

    function checkIfComplete() {
      const slots = Array.from(document.querySelectorAll('.slot'));
      const filled = slots.map(s => s.textContent || '');
      totalAttempts++;
      if (filled.every(Boolean)) {
        const answer = mode === 'sentence' ? filled.join(' ') : filled.join('');
        if (normalizePersian(answer) === normalizePersian(current)) {
          correctAttempts++;
          let multiplier = streak >= 10 ? 3 : streak >= 5 ? 2 : 1;
          score += (gameMode === 'challenge' ? current.length : 1) * multiplier;
          completedWords++;
          streak++;
          consecutiveMistakes = 0; // بازنشانی اشتباهات متوالی
          totalRoundTime += (Date.now() - roundStartTime) / 1000;
          updateProgress();
          updateStreak();
          scoreEl.textContent = score;
          slots.forEach(s => {
            s.classList.add('filled');
            s.style.boxShadow = '0 10px 30px rgba(43, 140, 255, 0.12)';
          });
          confetti({
            particleCount: 300,
            spread: 140,
            origin: { y: 0.5 },
            colors: ['#ff6f61', '#2ecc71', '#ffd700', '#8e44ad', '#3498db']
          });
          checkAchievements();
          const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
          Swal.fire({
            icon: 'success',
            title: 'آفرین!',
            text: `${randomMessage} امتیاز: ${score}${multiplier > 1 ? ` (ضریب x${multiplier})` : ''}`,
            timer: 1500,
            showConfirmButton: false
          });
          clearInterval(timerInterval);
          timerCircleEl.style.display = 'none';
          setTimeout(newRound, 1500);
        } else {
          mistakeCount--;
          consecutiveMistakes++;
          mistakesEl.textContent = `اشتباهات باقی‌مانده: ${mistakeCount}`;
          if (mistakeCount <= 0) {
            Swal.fire({
              icon: 'error',
              title: 'اشتباهات تمام شد!',
              text: 'تعداد اشتباهاتت تموم شد. دوباره تلاش کن یا از «جدید» استفاده کن.',
              confirmButtonText: 'باشه'
            });
            streak = 0;
            updateStreak();
            retryRound();
            return;
          }
          Swal.fire({
            icon: 'error',
            title: 'اشتباه!',
            text: `ترتیب درست نیست. دوباره تلاش کن. اشتباهات باقی‌مانده: ${mistakeCount}`,
            confirmButtonText: 'باشه'
          });
          slots.forEach(s => {
            s.classList.remove('filled');
            s.classList.add('incorrect');
            setTimeout(() => s.classList.remove('incorrect'), 300);
          });
          streak = 0;
          updateStreak();
        }
      }
      updateStats();
    }

    function checkAchievements() {
      if (completedWords >= 5 && !achievements.fiveInRow) {
        achievements.fiveInRow = true;
        Swal.fire({
          icon: 'success',
          title: 'دستاورد جدید!',
          text: 'پنج کلمه یا جمله پشت سر هم!',
          confirmButtonText: 'عالی!'
        });
        scoreEl.style.animation = 'pulse 1s';
        setTimeout(() => scoreEl.style.animation = '', 1000);
      }
      if (score >= 10 && !achievements.tenPoints) {
        achievements.tenPoints = true;
        Swal.fire({
          icon: 'success',
          title: 'دستاورد جدید!',
          text: 'کسب 10 امتیاز!',
          confirmButtonText: 'عالی!'
        });
        scoreEl.style.animation = 'pulse 1s';
        setTimeout(() => scoreEl.style.animation = '', 1000);
      }
      localStorage.setItem('achievements', JSON.stringify(achievements));
    }

    function retryRound() {
      slotsEl.querySelectorAll('.slot').forEach(slot => {
        if (slot.dataset.occupied === 'true') {
          handleSlotClick(slot);
        }
      });
      moveCount = maxMoves; // بازنشانی تعداد حرکات
      mistakeCount = maxMistakes; // بازنشانی تعداد اشتباهات
      movesEl.textContent = `حرکات باقی‌مانده: ${moveCount}`;
      mistakesEl.textContent = `اشتباهات باقی‌مانده: ${mistakeCount}`;
      msgEl.textContent = 'اسلات‌ها پاک شدند. دوباره تلاش کن!';
      streak = 0;
      updateStreak();
    }

    function shuffleTiles() {
      const children = Array.from(scrambledEl.children);
      shuffle(children);
      scrambledEl.innerHTML = '';
      children.forEach(c => scrambledEl.appendChild(c));
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeBtn').textContent = '🌙 تم';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').textContent = '☀️ تم';
      }
      saveSettings();
    }

    function resetGame() {
      Swal.fire({
        icon: 'warning',
        title: 'بازنشانی بازی',
        text: 'آیا مطمئن هستید که می‌خواهید امتیاز، رگه، سطح و پیشرفت را بازنشانی کنید؟',
        showCancelButton: true,
        confirmButtonText: 'بله',
        cancelButtonText: 'خیر'
      }).then(result => {
        if (result.isConfirmed) {
          score = 0;
          completedWords = 0;
          totalWords = 0;
          streak = 0;
          level = 1;
          totalAttempts = 0;
          correctAttempts = 0;
          totalRoundTime = 0;
          consecutiveMistakes = 0;
          usedSentences = [];
          achievements = { fiveInRow: false, tenPoints: false };
          localStorage.setItem('usedSentences', JSON.stringify(usedSentences));
          localStorage.setItem('achievements', JSON.stringify(achievements));
          scoreEl.textContent = score;
          updateProgress();
          updateStreak();
          levelEl.textContent = `سطح: ${level}`;
          slotsEl.innerHTML = '';
          scrambledEl.innerHTML = '';
          promptEl.textContent = 'برای شروع «جدید» را بزن';
          clearInterval(timerInterval);
          timerCircleEl.style.display = 'none';
          moveCount = maxMoves;
          mistakeCount = maxMistakes;
          movesEl.textContent = `حرکات باقی‌مانده: ${moveCount}`;
          mistakesEl.textContent = `اشتباهات باقی‌مانده: ${mistakeCount}`;
          Swal.fire({
            icon: 'success',
            title: 'بازنشانی شد',
            text: 'بازی بازنشانی شد. حالا «جدید» را بزن!',
            timer: 1500,
            showConfirmButton: false
          });
        }
      });
    }

    function printReportCard() {
      Swal.fire({
        title: 'مشخصات کارنامه',
        html:
          `<input type="text" id="firstName" class="swal2-input" placeholder="نام" value="${userInfo.firstName || ''}">` +
          `<input type="text" id="lastName" class="swal2-input" placeholder="نام خانوادگی" value="${userInfo.lastName || ''}">` +
          `<input type="text" id="nationalId" class="swal2-input" placeholder="کد ملی" value="${userInfo.nationalId || ''}">` +
          `<input type="text" id="schoolName" class="swal2-input" placeholder="نام مدرسه" value="${userInfo.schoolName || ''}">` +
          `<input type="text" id="grade" class="swal2-input" placeholder="پایه تحصیلی" value="${userInfo.grade || ''}">`,
        focusConfirm: false,
        confirmButtonText: 'تأیید و نمایش کارنامه',
        cancelButtonText: 'لغو',
        showCancelButton: true,
        preConfirm: () => {
          return {
            firstName: document.getElementById('firstName').value || 'نام',
            lastName: document.getElementById('lastName').value || 'نام خانوادگی',
            nationalId: document.getElementById('nationalId').value || 'کد ملی',
            schoolName: document.getElementById('schoolName').value || 'نام مدرسه',
            grade: document.getElementById('grade').value || 'پایه تحصیلی'
          };
        }
      }).then(result => {
        if (result.isConfirmed) {
          userInfo = result.value;
          localStorage.setItem('userInfo', JSON.stringify(userInfo));
          const accuracy = totalAttempts > 0 ? Math.round((correctAttempts / totalAttempts) * 100) : 0;
          const avgTime = completedWords > 0 ? Math.round(totalRoundTime / completedWords) : 0;
          const accuracyRating = accuracy >= 90 ? 'عالی' : accuracy >= 70 ? 'خوب' : accuracy >= 50 ? 'متوسط' : 'نیاز به بهبود';
          const avgTimeRating = avgTime <= 10 ? 'عالی' : avgTime <= 20 ? 'خوب' : avgTime <= 30 ? 'متوسط' : 'نیاز به بهبود';
          const streakRating = streak >= 10 ? 'عالی' : streak >= 5 ? 'خوب' : streak >= 1 ? 'متوسط' : 'نیاز به بهبود';
          const levelRating = level >= 5 ? 'عالی' : level >= 3 ? 'خوب' : level >= 2 ? 'متوسط' : 'نیاز به بهبود';
          const reportCardHtml = `
            <div style="font-family: 'Vazir', sans-serif; direction: rtl; text-align: right; padding: 20px; max-width: 800px; margin: 0 auto;">
              <h2 style="text-align: center; color: var(--accent);">کارنامه بازی املا</h2>
              <h3 style="text-align: center; color: var(--text);">مرتب‌سازی حروف و جملات (مخصوص دانش‌آموزان ابتدایی)</h3>
              <p style="text-align: center;">${new Date().toLocaleDateString('fa-IR')}</p>
              <hr style="border: 1px solid var(--accent); margin: 20px 0;">
              <h3>مشخصات دانش‌آموز</h3>
              <table style="width: 100%; margin-bottom: 20px;">
                <tr><td style="padding: 8px;"><b>نام:</b></td><td style="padding: 8px;">${userInfo.firstName}</td></tr>
                <tr><td style="padding: 8px;"><b>نام خانوادگی:</b></td><td style="padding: 8px;">${userInfo.lastName}</td></tr>
                <tr><td style="padding: 8px;"><b>کد ملی:</b></td><td style="padding: 8px;">${userInfo.nationalId}</td></tr>
                <tr><td style="padding: 8px;"><b>نام مدرسه:</b></td><td style="padding: 8px;">${userInfo.schoolName}</td></tr>
                <tr><td style="padding: 8px;"><b>پایه تحصیلی:</b></td><td style="padding: 8px;">${userInfo.grade}</td></tr>
              </table>
              <h3>عملکرد در بازی</h3>
              <table style="width: 100%; margin-bottom: 20px;">
                <tr><td style="padding: 8px;"><b>امتیاز:</b></td><td style="padding: 8px;">${score}</td></tr>
                <tr><td style="padding: 8px;"><b>سطح:</b></td><td style="padding: 8px;">${level}</td></tr>
                <tr><td style="padding: 8px;"><b>رگه (پاسخ‌های متوالی درست):</b></td><td style="padding: 8px;">${streak}</td></tr>
                <tr><td style="padding: 8px;"><b>کلمات/جملات کامل‌شده:</b></td><td style="padding: 8px;">${completedWords}</td></tr>
                <tr><td style="padding: 8px;"><b>کل کلمات/جملات:</b></td><td style="padding: 8px;">${totalWords}</td></tr>
                <tr><td style="padding: 8px;"><b>دقت:</b></td><td style="padding: 8px;">${accuracy}%</td></tr>
                <tr><td style="padding: 8px;"><b>میانگین زمان هر دور:</b></td><td style="padding: 8px;">${avgTime} ثانیه</td></tr>
              </table>
              <h3>تحلیل هوش و توانایی</h3>
              <table class="report-card-table">
                <tr>
                  <th>معیار</th>
                  <th>نمره</th>
                  <th>توضیح</th>
                </tr>
                <tr>
                  <td>دقت</td>
                  <td>${accuracyRating}</td>
                  <td>دقت بالا نشان‌دهنده توانایی قوی در املا و تشخیص ترتیب درست است.</td>
                </tr>
                <tr>
                  <td>سرعت</td>
                  <td>${avgTimeRating}</td>
                  <td>سرعت بالا نشان‌دهنده واکنش سریع و تمرکز قوی است.</td>
                </tr>
                <tr>
                  <td>رگه</td>
                  <td>${streakRating}</td>
                  <td>رگه بالا نشان‌دهنده ثبات و پشتکار در حل مسائل است.</td>
                </tr>
                <tr>
                  <td>سطح</td>
                  <td>${levelRating}</td>
                  <td>سطح بالا نشان‌دهنده پیشرفت قابل‌توجه در بازی است.</td>
                </tr>
              </table>
              <p style="text-align: center; font-size: 12px; margin-top: 20px;">
                این کارنامه نشان‌دهنده عملکرد دانش‌آموز در بازی آموزشی املا است.<br>
                تاریخ: ${new Date().toLocaleDateString('fa-IR')}
              </p>
            </div>
          `;
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = reportCardHtml;
          document.body.appendChild(tempDiv);
          Swal.fire({
            title: 'کارنامه شما',
            html: reportCardHtml,
            showCancelButton: true,
            confirmButtonText: 'چاپ',
            cancelButtonText: 'بستن',
            showDenyButton: true,
            denyButtonText: 'دانلود عکس',
            showCloseButton: true,
            width: '800px'
          }).then(result => {
            if (result.isConfirmed) {
              html2canvas(tempDiv, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const printFrame = document.getElementById('printFrame');
                const doc = printFrame.contentWindow.document;
                doc.open();
                doc.write(`
                  <html>
                    <head>
                      <style>
                        body { margin: 0; display: flex; justify-content: center; align-items: center; }
                        img { max-width: 100%; height: auto; }
                      </style>
                    </head>
                    <body>
                      <img src="${imgData}" style="max-width: 210mm; max-height: 297mm;">
                    </body>
                  </html>
                `);
                doc.close();
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                confetti({
                  particleCount: 200,
                  spread: 100,
                  origin: { y: 0.5 },
                  colors: ['#ff6f61', '#2ecc71', '#ffd700']
                });
                Swal.fire({
                  icon: 'success',
                  title: 'کارنامه آماده چاپ',
                  text: 'تصویر کارنامه شما برای چاپ آماده است! 🖨️',
                  timer: 1500,
                  showConfirmButton: false
                });
                document.body.removeChild(tempDiv);
              });
            } else if (result.isDenied) {
              html2canvas(tempDiv, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'report_card.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                Swal.fire({
                  icon: 'success',
                  title: 'دانلود عکس',
                  text: 'تصویر کارنامه دانلود شد! 🎉',
                  timer: 1500,
                  showConfirmButton: false
                });
                document.body.removeChild(tempDiv);
              });
            } else {
              document.body.removeChild(tempDiv);
            }
          });
        }
      });
    }

    function suggestSentences() {
      Swal.fire({
        title: 'پیشنهاد جملات',
        html: `<input type="text" id="ageGrade" class="swal2-input" placeholder="سن یا پایه (مثال: سوم ابتدایی)">`,
        confirmButtonText: 'تولید جملات',
        cancelButtonText: 'لغو',
        showCancelButton: true,
        preConfirm: () => {
          return document.getElementById('ageGrade').value;
        }
      }).then(result => {
        if (result.isConfirmed) {
          const input = result.value.toLowerCase().trim();
          let suggestedSentences = [];
          if (input.includes('اول') || input.includes('1')) {
            suggestedSentences = [
              'من به مدرسه می‌روم',
              'این یک کتاب است',
              'ما بازی می‌کنیم',
              'خورشید می‌درخشد',
              'گربه روی دیوار است'
            ];
          } else if (input.includes('دوم') || input.includes('2')) {
            suggestedSentences = [
              'من سیب می‌خورم',
              'کتاب روی میز است',
              'ما به پارک می‌رویم',
              'پرنده آواز می‌خواند',
              'امروز روز خوبی است'
            ];
          } else if (input.includes('سوم') || input.includes('3')) {
            suggestedSentences = [
              'پرنده در آسمان پرواز می‌کند',
              'ما در حیاط بازی می‌کنیم',
              'خورشید در آسمان است',
              'گربه روی درخت می‌رود',
              'من کتاب می‌خوانم'
            ];
          } else {
            suggestedSentences = [
              'من به مدرسه می‌روم',
              'این یک کتاب است',
              'ما بازی می‌کنیم',
              'خورشید در آسمان است',
              'گربه روی دیوار است',
              'من سیب می‌خورم',
              'کتاب روی میز است',
              'ما به پارک می‌رویم',
              'پرنده در آسمان پرواز می‌کند',
              'امروز روز خوبی است'
            ];
          }
          wordListEl.value = suggestedSentences.join('\n');
          Swal.fire({
            icon: 'success',
            title: 'جملات پیشنهادی',
            text: 'فهرست جملات به‌روزرسانی شد. برای ذخیره، «اعمال فهرست» را بزن.',
            timer: 2000,
            showConfirmButton: false
          });
        }
      });
    }

    document.getElementById('newBtn').addEventListener('click', () => {
      newRound();
    });
    document.getElementById('shuffleTiles').addEventListener('click', () => {
      shuffleTiles();
    });
    document.getElementById('checkBtn').addEventListener('click', () => {
      checkIfComplete();
    });
    document.getElementById('retryBtn').addEventListener('click', () => {
      retryRound();
    });
    document.getElementById('themeBtn').addEventListener('click', () => {
      toggleTheme();
    });
    document.getElementById('resetBtn').addEventListener('click', () => {
      resetGame();
    });
    document.getElementById('printBtn').addEventListener('click', () => {
      printReportCard();
    });
    document.getElementById('suggestBtn').addEventListener('click', () => {
      suggestSentences();
    });
    document.getElementById('applyBtn').addEventListener('click', () => {
      Swal.fire({
        icon: 'warning',
        title: 'اعمال فهرست',
        text: 'آیا مطمئن هستید که می‌خواهید فهرست جملات را به‌روزرسانی کنید؟',
        showCancelButton: true,
        confirmButtonText: 'بله',
        cancelButtonText: 'خیر'
      }).then(result => {
        if (result.isConfirmed) {
          saveWordList();
        }
      });
    });
    document.getElementById('modeBtn').addEventListener('click', () => {
      if (mode === 'syllable') {
        mode = 'letter';
        document.getElementById('modeBtn').textContent = 'حالت: حرف';
      } else if (mode === 'letter') {
        mode = 'sentence';
        document.getElementById('modeBtn').textContent = 'حالت: جمله';
      } else {
        mode = 'syllable';
        document.getElementById('modeBtn').textContent = 'حالت: سیلاب';
      }
      saveSettings();
    });
    document.getElementById('gameModeBtn').addEventListener('click', () => {
      if (gameMode === 'normal') {
        gameMode = 'timed';
        document.getElementById('gameModeBtn').textContent = 'حالت بازی: زمان‌دار';
      } else if (gameMode === 'timed') {
        gameMode = 'challenge';
        document.getElementById('gameModeBtn').textContent = 'حالت بازی: چالش';
        clearInterval(timerInterval);
        timerCircleEl.style.display = 'none';
        promptEl.textContent = mode === 'sentence' ? 'جمله جدید — ترتیب را درست کن' : `کلمه جدید — ترتیب را درست کن: ${current}`;
      } else {
        gameMode = 'normal';
        document.getElementById('gameModeBtn').textContent = 'حالت بازی: عادی';
        clearInterval(timerInterval);
        timerCircleEl.style.display = 'none';
        promptEl.textContent = mode === 'sentence' ? 'جمله جدید — ترتیب را درست کن' : `کلمه جدید — ترتیب را درست کن: ${current}`;
      }
      saveSettings();
    });

    (function init() {
      loadWordList();
      loadSettings();
      scoreEl.textContent = score;
      updateProgress();
      updateStreak();
      levelEl.textContent = `سطح: ${level}`;
      movesEl.textContent = `حرکات باقی‌مانده: ${moveCount}`;
      mistakesEl.textContent = `اشتباهات باقی‌مانده: ${mistakeCount}`;
      msgEl.textContent = 'برای شروع «جدید» را بزن. فقط جملات را در فهرست وارد کن!';
    })();
  </script>
</body>
</html>